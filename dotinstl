#!/usr/bin/zsh
setopt extendedglob

readonly \
  SCRIPT_NAME="${0:t}" \
  SRCDIR="${0:A:h}/src"
  DOTDIR="${0:A:h}/dots"

alias exists="> /dev/null type -p"

dot_err () {
  local -r \
    RED='\033[0;31m' \
    COLOR_OFF='\033[0m'

  print -u2 "${RED}${@}${COLOR_OFF}"
}

. ${SRCDIR}/options
. ${SRCDIR}/dependencies
. ${SRCDIR}/installd

finish () {
  rm -rf /tmp/package-query
  rm -rf /tmp/yaourt
  rm -rf /tmp/dzvol
  rm -f  /tmp/installer.sh
  rm -f /tmp/pyth3-pypeg.deb
  rm -f /tmp/qutebrowser.deb
  rm -f /tmp/antibody.tar.gz
  rm -f /tmp/hub.tgz
  rm -rf /tmp/hub-linux-amd64*/
}

usage () {
  cat <<EOF
usage: ${SCRIPT_NAME} [-aztnxi]
       ${SCRIPT_NAME} [-aztnxu]

  -a      Install all dotfiles
  -i      Install package dependencies for chosen dotfiles
  -u      Uninstall chosen dotfiles
  -z      Install Zsh dotfiles
  -t      Install Tmux dotfiles
  -g      Install GHCi dotfiles
  -n      Install Neovim dotfiles
  -x      Install X11 dotfiles
  -h      Print this usage message
EOF
}

main () {
  trap "trap - SIGTERM && finish &> /dev/null && kill -- -$$" \
    SIGINT SIGTERM EXIT

  { [[ $ZSH_VERSION > 5.2 ]] || [[ $ZSH_VERSION == 5.2 ]] } \
    || {
      printf "zsh version must be higher than 5.2\n"
      exit
    }

  local -Ua \
    FLAGS \
    missing_dependencies

  # distro dependencies for arch and ubuntu
  local -Ar YAOURT_DEPENDENCIES=( \
    zsh     "antibody fzf hub tig lsof trash-cli git" \
    ghci    "ghc haskell-stack haskell-hscolour haskell-pretty-show" \
    tmux    "tmux bind-tools acpi git powerline-fonts-git" \
    neovim  "neovim python-neovim python \
              ghc-mod rust-racer clang shellcheck \
              eslint tidy go git" \
    x11     "xmonad qutebrowser mpv xss-lock-git xautolock \
              xbanish unclutter-xfixes-git slock xorg-xsetroot \
              compton xmonad-contrib scrot xorg-xset git"
  )

  local -Ar APT_DEPENDENCIES=( \
    zsh     "antibody lsof trash-cli hub tig git" \
    ghci    "ghc haskell-stack libghc-hscolour-dev libghc-pretty-show-dev" \
    tmux    "tmux acpi dnsutils git" \
    neovim  "neovim python3 python3-pip ghc-mod clang shellcheck \
              tidy golang git" \
    x11     "xmonad mpv xss-lock xautolock suckless-tools \
              compton libghc-xmonad-contrib-dev scrot \
              x11-xserver-utils qutebrowser git"
  )

  options $@

  dependencies

  installd
}

 main $@
