dependencies () {
  dependencies::check \
    || finish::failed

  [[ ${install_deps} == 1 ]] &&
    dependencies::install

  {
    [[ -z ${missing_dependencies} ]] \
      || [[ ${CMD} == "rm" ]]
  } \
    || {
      dot_err "depenencies are not satisfied.\ntry installing with -i"
      finish::failed
    }
}

dependencies::check () {
  # TODO add more package managers
  if exists pacman; then
    local -r \
      search_pkg_db="pacman -Q" \
      dependencies=YAOURT_DEPENDENCIES
  elif exists apt-get; then
    local -r\
      search_pkg_db="dpkg -l" \
      dependencies=APT_DEPENDENCIES
  else
    dot_err "your *nix is not supported"
    finish::failed
  fi

  if [[ ${all} == 1 ]]; then
    for key in ${(P@k)dependencies}; do
      for package in ${=${(P)dependencies}[${key}]}; do
        dependencies::check::package ${package}
      done
    done
  else
    for flag in ${flags[@]/install_deps}; do
      for package in ${=${(P)dependencies}[${flag}]}; do
        dependencies::check::package ${package}
      done
    done
  fi
}

dependencies::check::package () {
  local -r \
    package=$1

  {
    ${=search_pkg_db} ${package} \
      || ${=search_pkg_db} ${package}-git
  } &> /dev/null \
    || {
      if [[ ${package} =~ 'antibody|hub' ]]; then
        exists ${package} \
          || {
            print -c -u2 "${package}" "is not installed"
            missing_dependencies+=${package}
          }
      else
        print -c -u2 "${package}" "is not installed"
        missing_dependencies+=${package}
      fi
    }
}

dependencies::install () {
  if [[ -z ${missing_dependencies} ]]; then
    print "all dependencies are already installed... continuing"
  else
    if exists yaourt; then
      yaourt -S ${missing_dependencies} --noconfirm --needed \
        && missing_dependencies=()
    elif exists pacman; then
      print "yaourt not detected; building it..."
      dependencies::install::yaourt \
        || {
            dot_err "yaourt failed to install; dependencies not installed"
            return 1
        }
      yaourt -S ${missing_dependencies} --noconfirm --needed \
        && missing_dependencies=()
    elif exists apt-get; then
      dependencies::install::ubuntu
      sudo apt-get install -y ${missing_dependencies} \
        && missing_dependencies=()
    else
      dot_err "installing dependecies is not support on your *nix"
    fi
  fi
}

dependencies::install::yaourt () {
  local -i value
  if
    {
      sudo pacman -S base-devel --needed --noconfirm \
        || sudo pacman -S multilib-devel --needed --noconfirm \
        && git clone https://aur.archlinux.org/package-query.git \
          ${TMPDIR}/package-query > /dev/null \
        && (
          cd ${TMPDIR}/package-query \
            || return 1 \
            && makepkg -si --noconfirm --needed \
        ) \
        && git clone https://aur.archlinux.org/yaourt.git \
          ${TMPDIR}/yaourt > /dev/null \
        && (
          cd ${TMPDIR}/yaourt \
            || return 1 \
            && makepkg -si --noconfirm --needed \
        )
    }
  then
    value=0
  else
    value=1
  fi

  return ${value}
}

dependencies::install::ubuntu () {
  [[ ${flags[zsh]} == 1 ]] || [[ ${flags[all]} == 1 ]] \
    && {
      (( ${missing_dependencies[(I)antibody]} )) \
        && curl -sL https://git.io/antibody | bash -s \
        && missing_dependencies=(${(@)missing_dependencies:#antibody})

      (( ${missing_dependencies[(I)hub]} )) \
        && {
          # download latest hub release
          curl -s -L https://github.com/github/hub/releases/latest \
            | egrep -o 'github/hub/releases/download/.*/hub-linux-amd64.*\.tgz' \
            | wget --base=http://github.com/ -i - -O ${TMPDIR}/hub.tgz

          (
            cd ${TMPDIR} || return 1
            tar xvfz ./hub.tgz
            sudo hub-linux-amd64*/install
          )

        } \
        && missing_dependencies=(${(@)missing_dependencies:#hub})
    }

  [[ ${flags[neovim]} == 1 ]] || [[ ${flags[all]} == 1 ]] \
    && {
      (( ${missing_dependencies[(I)neovim]} )) \
        && {
          sudo add-apt-repository -y ppa:neovim-ppa/unstable
          sudo apt-get -y update
          sudo apt-get install -y neovim python3-pip
          pip3 install --upgrade neovim
        }
    }

  [[ ${flags[x11]} == 1 ]] || [[ ${flags[all]} == 1 ]] \
    && {
      (( ${missing_dependencies[(I)qutebrowser]} )) \
        && {
          # download latest qutebrowser release
          curl -s -L https://github.com/qutebrowser/qutebrowser/releases/latest \
            | egrep -o 'qutebrowser/qutebrowser/releases/download/.*/.*\.deb' \
            | wget --base=http://github.com/ -i - -O ${TMPDIR}/qutebrowser.deb
          wget https://qutebrowser.org/python3-pypeg2_2.15.2-1_all.deb \
            -O ${TMPDIR}/python3-pypeg.deb

          sudo apt-get install -y ${TMPDIR}/python3-pypeg.deb
          sudo apt-get install -y ${TMPDIR}/qutebrowser.deb

        } \
        && missing_dependencies=(${(@)missing_dependencies:#qutebrowser})
    }
}
